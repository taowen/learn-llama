# tensor 之间的依赖关系
* [tensor 之间的计算算法](run-with-kv-cache.py)
* [tensor 的 shape 和具体样本](run-with-kv-cache)

```mermaid
graph TD;
input_string-->input_ids;
input_ids[input_ids<br/>7<br/>所有输入token的长度];
input_ids-->prefill_input_ids;
prefill_input_ids[prefill_input_ids<br/>6<br/>填充缓存的token序列];
input_ids-->predict_input_ids;
predict_input_ids[predict_input_ids<br/>1<br/>预测的token序列];
subgraph 用前6个token prefill;
prefill_input_ids-->prefill_input_embeds;
prefill_input_embeds[prefill_input_embeds<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_input_embeds-->prefill_input_layernormed;
prefill_input_layernormed[prefill_input_layernormed<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_input_layernormed-->prefill_query_states;
prefill_query_states[prefill_query_states<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_input_layernormed-->prefill_key_states;
prefill_key_states[prefill_key_states<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_input_layernormed-->prefill_value_states;
prefill_value_states[prefill_value_states<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_query_states-->prefill_pos_query_states;
prefill_pos_query_states[prefill_pos_query_states<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_key_states-->prefill_pos_key_states;
prefill_pos_key_states[prefill_pos_key_states<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_pos_query_states-->prefill_unmasked_attn_weights;
prefill_pos_key_states-->prefill_unmasked_attn_weights;
prefill_unmasked_attn_weights[prefill_unmasked_attn_weights<br/>32, 6, 6<br/>头的个数, 填充缓存的token序列, 填充缓存的token序列];
prefill_causal_mask[prefill_causal_mask<br/>1, 6, 6<br/>固定为1,表示对所有的头使用相同的mask, 填充缓存的token序列, 填充缓存的token序列];
prefill_unmasked_attn_weights-->prefill_masked_attn_weights;
prefill_causal_mask-->prefill_masked_attn_weights;
prefill_masked_attn_weights[prefill_masked_attn_weights<br/>32, 6, 6<br/>头的个数, 填充缓存的token序列, 填充缓存的token序列];
prefill_masked_attn_weights-->prefill_attn_weights;
prefill_attn_weights[prefill_attn_weights<br/>32, 6, 6<br/>头的个数, 填充缓存的token序列, 填充缓存的token序列];
prefill_attn_weights-->prefill_attn_tmp_output1;
prefill_value_states-->prefill_attn_tmp_output1;
prefill_attn_tmp_output1[prefill_attn_tmp_output1<br/>32, 6, 100<br/>头的个数, 填充缓存的token序列, 每头 hidden size];
prefill_attn_tmp_output1-->prefill_attn_tmp_output2;
prefill_attn_tmp_output2[prefill_attn_tmp_output2<br/>6, 32, 100<br/>填充缓存的token序列, 头的个数, 每头 hidden size];
prefill_attn_tmp_output2-->prefill_attn_tmp_output3;
prefill_attn_tmp_output3[prefill_attn_tmp_output3<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_input_embeds-->prefill_attn_output;
prefill_attn_tmp_output3-->prefill_attn_output;
prefill_attn_output[prefill_attn_output<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_attn_output-->prefill_attn_output_layernormed;
prefill_attn_output_layernormed[prefill_attn_output_layernormed<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_attn_output-->prefill_layer_output;
prefill_attn_output_layernormed-->prefill_layer_output;
prefill_layer_output[prefill_layer_output<br/>6, 3200<br/>填充缓存的token序列, 模型 hidden size];
prefill_layer_output --循环26次--> prefill_input_embeds;
end;
subgraph 用第7个 token predict 第8个 token;
predict_input_ids-->predict_input_embeds;
predict_input_embeds[predict_input_embeds<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
predict_input_embeds-->input_layernormed;
input_layernormed[input_layernormed<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
input_layernormed-->query_states;
query_states[query_states<br/>32, 1, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
input_layernormed-->more_key_states;
more_key_states[more_key_states<br/>32, 1, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
input_layernormed-->more_value_states;
more_value_states[more_value_states<br/>32, 1, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
prefill_pos_key_states-->pos_query_states;
query_states-->pos_query_states;
pos_query_states[pos_query_states<br/>32, 1, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
prefill_pos_key_states-->pos_more_key_states;
more_key_states-->pos_more_key_states;
pos_more_key_states[pos_more_key_states<br/>32, 1, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
prefill_pos_key_states-->pos_key_states;
pos_more_key_states-->pos_key_states;
pos_key_states[pos_key_states<br/>32, 7, 100<br/>全token序列, 头的个数, 每头 hidden size];
prefill_value_states-->value_states;
more_value_states-->value_states;
value_states[value_states<br/>32, 7, 100<br/>全token序列, 头的个数, 每头 hidden size];
pos_query_states-->attn_weights;
pos_key_states-->attn_weights;
attn_weights[attn_weights<br/>32, 1, 7<br/>头的个数, 预测的token序列, 全token序列];
attn_weights-->attn_tmp_output1;
value_states-->attn_tmp_output1;
attn_tmp_output1[attn_tmp_output1<br/>32, 1, 100<br/>头的个数, 预测的token序列, 每头 hidden size];
attn_tmp_output1-->attn_tmp_output2;
attn_tmp_output2[attn_tmp_output2<br/>1, 32, 100<br/>预测的token序列, 头的个数, 每头 hidden size];
attn_tmp_output2-->attn_tmp_output3;
attn_tmp_output3[attn_tmp_output3<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
predict_input_embeds-->attn_output;
attn_tmp_output3-->attn_output;
attn_output[attn_output<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
attn_output-->attn_output_layernormed;
attn_output_layernormed[attn_output_layernormed<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
attn_output_layernormed-->gate_projected;
gate_projected[gate_projected<br/>1, 8640<br/>预测的token序列, intermediate size];
attn_output_layernormed-->up_projected;
up_projected[up_projected<br/>1, 8640<br/>预测的token序列, intermediate size];
gate_projected-->activated;
up_projected-->activated;
activated[activated<br/>1, 8640<br/>预测的token序列, intermediate size];
attn_output-->layer_output;
activated-->layer_output;
layer_output[layer_output<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
layer_output --循环26次--> predict_input_embeds;
layer_output-->output_layernormed;
output_layernormed[output_layernormed<br/>1, 3200<br/>预测的token序列, 模型 hidden size];
output_layernormed-->logits;
logits[logits<br/>1, 32000<br/>预测的token序列, 字典大小];
logits-->next_tokens;
next_tokens[next_tokens<br/>1<br/>一维数组];
end
```
